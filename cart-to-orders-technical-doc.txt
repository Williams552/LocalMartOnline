# TÃ i liá»‡u Ká»¹ thuáº­t - Äáº·t hÃ ng tá»« Giá» hÃ ng

## Tá»•ng quan
TÃ­nh nÄƒng cho phÃ©p ngÆ°á»i dÃ¹ng Ä‘áº·t hÃ ng tá»« giá» hÃ ng, tá»± Ä‘á»™ng chia thÃ nh nhiá»u Ä‘Æ¡n hÃ ng riÃªng biá»‡t theo tá»«ng cá»­a hÃ ng.

## API Endpoint

### POST /api/order/place-orders-from-cart

**Request Body:**
{
  "buyerId": "string",
  "notes": "string (optional)",
  "cartItems": [
    {
      "id": "string",
      "cartId": "string",
      "productId": "string",
      "quantity": number,
      "product": {
        "id": "string",
        "name": "string",
        "price": number,
        "images": "string",
        "unit": "string",
        "storeId": "string",
        "storeName": "string"
      }
    }
  ]
}

**Response Success (200):**
{
  "success": true,
  "message": "ÄÃ£ táº¡o thÃ nh cÃ´ng 3 Ä‘Æ¡n hÃ ng tá»« 3 cá»­a hÃ ng khÃ¡c nhau",
  "data": {
    "orderCount": 3,
    "totalAmount": 250000,
    "orders": [
      {
        "id": "order_id_1",
        "buyerId": "buyer_id",
        "sellerId": "seller_id_1", 
        "storeName": "Cá»­a hÃ ng A",
        "totalAmount": 100000,
        "status": "Pending",
        "paymentStatus": "Pending",
        "notes": "Ghi chÃº",
        "createdAt": "2025-07-22T10:30:00Z",
        "items": [
          {
            "productId": "product_1",
            "productName": "TÃ¡o Fuji",
            "productImageUrl": "image1.jpg",
            "productUnitName": "kg",
            "quantity": 2,
            "priceAtPurchase": 50000
          }
        ]
      }
    ]
  }
}

**Response Error (400/500):**
{
  "success": false,
  "message": "Lá»—i message",
  "error": "Chi tiáº¿t lá»—i"
}

## Luá»“ng xá»­ lÃ½ Frontend

### 1. Thu tháº­p dá»¯ liá»‡u
// Láº¥y cart items tá»« state/store
const cartItems = getCartItems();
const buyerId = getCurrentUserId();

### 2. Gá»i API
const placeOrdersFromCart = async (orderData) => {
  try {
    const response = await fetch('/api/order/place-orders-from-cart', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });
    
    const result = await response.json();
    return result;
  } catch (error) {
    throw error;
  }
};

### 3. Xá»­ lÃ½ káº¿t quáº£
const handlePlaceOrder = async () => {
  try {
    const result = await placeOrdersFromCart({
      buyerId,
      notes,
      cartItems
    });
    
    if (result.success) {
      // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng
      showSuccess(`ÄÃ£ táº¡o ${result.data.orderCount} Ä‘Æ¡n hÃ ng`);
      
      // XÃ³a cart
      clearCart();
      
      // Chuyá»ƒn Ä‘áº¿n trang order history
      navigateToOrderHistory();
    }
  } catch (error) {
    showError('CÃ³ lá»—i xáº£y ra khi Ä‘áº·t hÃ ng');
  }
};

## UI/UX Recommendations

### 1. Hiá»ƒn thá»‹ Preview trÆ°á»›c khi Ä‘áº·t hÃ ng
â”Œâ”€ XÃ¡c nháº­n Ä‘áº·t hÃ ng â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“¦ Cá»­a hÃ ng A (2 sáº£n pháº©m) - 100,000Ä‘   â”‚
â”‚ ðŸ“¦ Cá»­a hÃ ng B (1 sáº£n pháº©m) - 50,000Ä‘    â”‚  
â”‚ ðŸ“¦ Cá»­a hÃ ng C (3 sáº£n pháº©m) - 150,000Ä‘   â”‚
â”‚                                         â”‚
â”‚ Tá»•ng cá»™ng: 300,000Ä‘                     â”‚
â”‚ Sá»‘ Ä‘Æ¡n hÃ ng sáº½ táº¡o: 3                   â”‚
â”‚                                         â”‚
â”‚ Ghi chÃº: [_________________________]    â”‚
â”‚                                         â”‚
â”‚ [Há»§y]  [XÃ¡c nháº­n Ä‘áº·t hÃ ng]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 2. Hiá»ƒn thá»‹ káº¿t quáº£
â”Œâ”€ Äáº·t hÃ ng thÃ nh cÃ´ng â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ÄÃ£ táº¡o thÃ nh cÃ´ng 3 Ä‘Æ¡n hÃ ng         â”‚
â”‚                                        â”‚
â”‚ ðŸ“‹ ÄÆ¡n hÃ ng #001 - Cá»­a hÃ ng A          â”‚
â”‚ ðŸ“‹ ÄÆ¡n hÃ ng #002 - Cá»­a hÃ ng B          â”‚
â”‚ ðŸ“‹ ÄÆ¡n hÃ ng #003 - Cá»­a hÃ ng C          â”‚
â”‚                                        â”‚
â”‚ [Xem Ä‘Æ¡n hÃ ng] [Tiáº¿p tá»¥c mua sáº¯m]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## Validation Rules

### Frontend Validation
- buyerId: Required, khÃ´ng Ä‘Æ°á»£c rá»—ng
- cartItems: Required, pháº£i cÃ³ Ã­t nháº¥t 1 item
- quantity: Pháº£i > 0
- price: Pháº£i > 0

### Business Rules
- Kiá»ƒm tra stock quantity trÆ°á»›c khi Ä‘áº·t hÃ ng
- Validate sáº£n pháº©m cÃ²n available
- Kiá»ƒm tra minimum order quantity

## Error Handling

| Error Code | Message | Xá»­ lÃ½ |
|------------|---------|-------|
| 400 | Giá» hÃ ng trá»‘ng | Hiá»ƒn thá»‹ thÃ´ng bÃ¡o, redirect vá» cart |
| 400 | Sáº£n pháº©m khÃ´ng kháº£ dá»¥ng | Highlight sáº£n pháº©m lá»—i, cho phÃ©p remove |
| 500 | Lá»—i server | Retry mechanism, fallback message |

## Test Cases

1. **Happy Path**: Cart cÃ³ sáº£n pháº©m tá»« 3 cá»­a hÃ ng â†’ Táº¡o 3 Ä‘Æ¡n hÃ ng
2. **Single Store**: Cart chá»‰ cÃ³ sáº£n pháº©m tá»« 1 cá»­a hÃ ng â†’ Táº¡o 1 Ä‘Æ¡n hÃ ng  
3. **Empty Cart**: Giá» hÃ ng trá»‘ng â†’ Show error
4. **Invalid Product**: Sáº£n pháº©m khÃ´ng tá»“n táº¡i â†’ Skip product, táº¡o Ä‘Æ¡n vá»›i cÃ¡c sáº£n pháº©m valid

## Backend Implementation Notes

### DTO cáº§n táº¡o:
- CartOrderCreateDto: Chá»©a thÃ´ng tin Ä‘áº·t hÃ ng tá»« cart (Ä‘Ã£ táº¡o)
- OrderItemDto: Cáº­p nháº­t Ä‘á»ƒ phÃ¹ há»£p vá»›i response

### Service Method:
- PlaceOrdersFromCartAsync(): NhÃ³m cart items theo storeId vÃ  táº¡o nhiá»u orders
- CreateNewOrderNotification(): Táº¡o notification ná»™i bá»™ cho seller

### Database Structure:
- Má»—i Order thuá»™c vá» 1 Seller duy nháº¥t (1:1)
- OrderItems thuá»™c vá» 1 Order (1:N)
- Cart Ä‘Æ°á»£c chia thÃ nh nhiá»u Orders theo StoreId
- Notification Ä‘Æ°á»£c táº¡o cho má»—i seller khi cÃ³ Ä‘Æ¡n hÃ ng má»›i

### Logic Flow:
1. Nháº­n cart items tá»« frontend
2. Láº¥y thÃ´ng tin buyer má»™t láº§n
3. Group theo product.storeId
4. Táº¡o Order riÃªng cho má»—i store
5. Táº¡o OrderItems cho má»—i Order
6. Táº¡o Notification cho má»—i seller
7. Return danh sÃ¡ch Orders Ä‘Ã£ táº¡o

### Notification Features:
- Tá»± Ä‘á»™ng táº¡o notification cho seller khi cÃ³ Ä‘Æ¡n hÃ ng má»›i
- Notification Ä‘Æ°á»£c lÆ°u trong database collection "Notifications"
- Seller cÃ³ thá»ƒ sá»­ dá»¥ng API cÃ³ sáºµn Ä‘á»ƒ láº¥y notifications:
  - GET /api/notification - Láº¥y notifications phÃ¢n trang (cáº§n userId trong token)
  - GET /api/notification/user/my/paged - Láº¥y notifications phÃ¢n trang cá»§a báº£n thÃ¢n
  - GET /api/notification/unread-count - Äáº¿m sá»‘ notification chÆ°a Ä‘á»c

### GET /api/notification/user/my/paged
**Description:** Láº¥y danh sÃ¡ch notifications phÃ¢n trang cá»§a user hiá»‡n táº¡i (láº¥y userId tá»« token)

**Headers:**
```
Authorization: Bearer {token}
```

**Query Parameters:**
- page: int (default: 1) - Trang hiá»‡n táº¡i
- limit: int (default: 10, max: 50) - Sá»‘ items per page

**Response Success (200):**
```json
{
  "success": true,
  "message": "Láº¥y danh sÃ¡ch thÃ´ng bÃ¡o thÃ nh cÃ´ng.",
  "data": {
    "notifications": [
      {
        "id": "notification_id",
        "userId": "user_id",
        "title": "ÄÆ¡n hÃ ng má»›i",
        "message": "Báº¡n cÃ³ Ä‘Æ¡n hÃ ng má»›i tá»« KhÃ¡ch hÃ ng A...",
        "type": "NEW_ORDER",
        "isRead": false,
        "createdAt": "2025-07-22T10:30:00Z"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 10,
      "totalItems": 25,
      "totalPages": 3,
      "hasNextPage": true,
      "hasPreviousPage": false
    }
  }
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c user tá»« token."
}
```

### Frontend Usage Example:
```javascript
const getMyNotifications = async (page = 1, limit = 10) => {
  try {
    const response = await fetch(`/api/notification/user/my/paged?page=${page}&limit=${limit}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('Error getting notifications:', error);
  }
};
```

### Notification Content:
- Title: "ÄÆ¡n hÃ ng má»›i"
- Message: "Báº¡n cÃ³ Ä‘Æ¡n hÃ ng má»›i tá»« [TÃªn khÃ¡ch hÃ ng] táº¡i cá»­a hÃ ng [TÃªn cá»­a hÃ ng]. GiÃ¡ trá»‹: [Sá»‘ tiá»n]Ä‘. MÃ£ Ä‘Æ¡n: #[Order ID]"
- Type: "NEW_ORDER"
- IsRead: false (máº·c Ä‘á»‹nh)

## Cancel Order API

### POST /api/order/{orderId}/cancel

**Description:** Há»§y Ä‘Æ¡n hÃ ng vá»›i lÃ½ do (buyer hoáº·c seller cÃ³ thá»ƒ há»§y)

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Route Parameters:**
- orderId: string - ID cá»§a Ä‘Æ¡n hÃ ng cáº§n há»§y

**Request Body:**
```json
{
  "cancelReason": "KhÃ´ng cÃ²n cáº§n sáº£n pháº©m nÃ y ná»¯a"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c há»§y thÃ nh cÃ´ng",
  "data": {
    "orderId": "64f8a2b1c3d4e5f6a7b8c9d0",
    "cancelReason": "KhÃ´ng cÃ²n cáº§n sáº£n pháº©m nÃ y ná»¯a",
    "status": "Cancelled",
    "updatedAt": "2025-07-22T10:30:00Z"
  }
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n hÃ ng á»Ÿ tráº¡ng thÃ¡i Delivering"
}
```

**Response Error (403):**
```json
{
  "success": false,
  "message": "Báº¡n khÃ´ng cÃ³ quyá»n há»§y Ä‘Æ¡n hÃ ng nÃ y"
}
```

**Business Rules:**
- Chá»‰ cÃ³ thá»ƒ há»§y khi tráº¡ng thÃ¡i: Pending, Confirmed
- Buyer cÃ³ thá»ƒ há»§y Ä‘Æ¡n hÃ ng cá»§a mÃ¬nh
- Seller cÃ³ thá»ƒ há»§y Ä‘Æ¡n hÃ ng trong cá»­a hÃ ng cá»§a mÃ¬nh
- Khi há»§y sáº½ gá»­i notification cho bÃªn cÃ²n láº¡i
- LÃ½ do há»§y lÃ  báº¯t buá»™c (10-500 kÃ½ tá»±)

## Order Status Flow

### Luá»“ng tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng:
1. **Pending** - NgÆ°á»i mua má»›i Ä‘áº·t hÃ ng
2. **Confirmed** - NgÆ°á»i bÃ¡n xÃ¡c nháº­n cÃ²n hÃ ng
3. **Paid** - NgÆ°á»i bÃ¡n xÃ¡c nháº­n Ä‘Ã£ nháº­n Ä‘Æ°á»£c tiá»n  
4. **Completed** - NgÆ°á»i mua xÃ¡c nháº­n Ä‘Ã£ nháº­n Ä‘Ãºng hÃ ng
5. **Cancelled** - ÄÆ¡n hÃ ng bá»‹ há»§y (cÃ³ thá»ƒ tá»« Pending hoáº·c Confirmed)

### API Endpoints cho Order Status:

#### POST /api/order/{orderId}/confirm
**Description:** Seller xÃ¡c nháº­n cÃ²n hÃ ng (Pending â†’ Confirmed)
**Authorization:** Seller, Admin
**Response:**
```json
{
  "success": true,
  "message": "ÄÃ£ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng",
  "data": { "orderId": "...", "status": "Confirmed" }
}
```

#### POST /api/order/{orderId}/mark-paid  
**Description:** Seller xÃ¡c nháº­n Ä‘Ã£ nháº­n tiá»n (Confirmed â†’ Paid)
**Authorization:** Seller, Admin
**Response:**
```json
{
  "success": true,
  "message": "ÄÃ£ xÃ¡c nháº­n nháº­n tiá»n thÃ nh cÃ´ng", 
  "data": { "orderId": "...", "status": "Paid" }
}
```

#### POST /api/order/{orderId}/complete
**Description:** Buyer xÃ¡c nháº­n Ä‘Ã£ nháº­n hÃ ng (Paid â†’ Completed) 
**Authorization:** Buyer, Admin
**Response:**
```json
{
  "success": true,
  "message": "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c thÃ nh cÃ´ng"
}
```

### Frontend Usage:
```javascript
const cancelOrder = async (orderId, cancelReason) => {
  const response = await fetch(`/api/order/${orderId}/cancel`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ cancelReason })
  });
  return await response.json();
};
```
